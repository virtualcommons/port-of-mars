# port-of-mars

[![Build Status](https://travis-ci.com/virtualcommons/port-of-mars.svg?token=Axd1f7q98op1tRxrKi92&branch=master)](https://travis-ci.com/virtualcommons/port-of-mars)

## About

[Port of Mars](https://interplanetary.asu.edu/port-of-mars) is an interdisciplinary research project sponsored by [Arizona State University's](https://www.asu.edu) [Interplanetary Initiative](https://interplanetary.asu.edu/). Its original incarnation was designed and implemented as a physical card game for 5 players. We are now a developing digital version of the Port of Mars card game to serve as a scalable research testbed for studying collective action.

If you'd like to get involved, please [let us know!](https://complexity.asu.edu/contact)

## Build the Codebase

### Development Setup

These instructions are intended for Linux / MacOS (less tested on MacOS; please submit an issue or PR if you encounter any problems) and assume you have recent versions of [Docker](https://docs.docker.com/engine/install/#server) and [Docker Compose](https://docs.docker.com/compose/install/) installed on your system (you may also need to install [make](https://www.gnu.org/software/make/)).

To create a development environment for your client and server run

```bash
% ./configure dev
% make secrets
% make
```

This creates secrets for the database, creates a `docker-compose.yml` file and builds the `client` and `server` docker images.

Now run

```
% docker-compose up -d
```

and you should have a working development environment if your database was already setup.

In order to setup your database you'll need to run

```
% docker-compose exec server bash
% yarn typeorm schema:drop
% yarn typeorm migration:run
% yarn load-fixtures
```

Now you should be able to login into the website using the development login using any username you wish.

Tests for the project can be run with

```
% make test
```

The `docker-compose.yml` file is automatically generated from a template and can be regenerated by running `make docker-compose.yml` (e.g., to apply changes in the template).

The `make browser` target requires the `open-url-in-container` Firefox extension: https://addons.mozilla.org/en-US/firefox/addon/open-url-in-container/


### Staging Setup

```bash
% ./configure staging
% make deploy
```

### Production Setup

Copy the Sentry DSN url into `keys/sentry_dsn`. Then 

```bash
% ./configure prod
% make deploy
```

### Data Export

In development, data can be exported from the database by running:

```bash
% ./dump.sh dev # all games
% ./dump.sh dev --ids 1 2 4 6 # games matching ids
```

In staging or production, change `dev` to `prod`:

```bash
% ./dump.sh prod # all games
% ./dump.sh prod --ids 1 2 4 6 # game matching ids
```


This generates CSV files with every persisted game event as well as summary csv files with game, player and tournament data. The csv files will be in the `docker/dump` folder. You can pack the results into an archive with `zip -r <name-of-archive> docker/dump/processed`.
