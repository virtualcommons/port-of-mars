<template>
  <div v-if="layout !== 'DISABLE_CHAT'" class="chat v-step-16">
    <p class="title">Chat</p>

    <div class="messages-view">
      <div class="wrapper">
        <p v-if="messages.length === 0" class="empty">
          No Messages
        </p>
        <div
          class="message"
          v-for="message in messages"
          :key="message.dateCreated"
        >
          <p class="member">
            {{ message.role }}
          </p>
          <p class="content">
            {{ message.message }}
          </p>
          <p class="time">
            <span>[ </span>{{ toDate(message.dateCreated) }}<span> ]</span>
          </p>
        </div>
      </div>
    </div>

    <div class="input-frame">
      <input
        class="chat-input"
        @keydown.enter="submitToChat"
        v-model="pendingMessage"
        type="text"
        placeholder="send a message"
      />
      <font-awesome-icon
        :icon="['far', 'paper-plane']"
        class="chat-input-sendbtn"
        size="lg"
      />
    </div>
  </div>
  <div v-else-if="layout === 'DISABLE_CHAT'" class="chat-disabled">
    <div class="wrapper">
      <p>Chat is disabled this round.</p>
    </div>
  </div>
</template>

<script lang="ts">
import { Vue, Component, InjectReactive, Inject } from 'vue-property-decorator';
import { GameRequestAPI } from '@/api/game/request';
import { library } from '@fortawesome/fontawesome-svg-core';
import { faPaperPlane } from '@fortawesome/free-regular-svg-icons/faPaperPlane';
import { FontAwesomeIcon } from '@fortawesome/vue-fontawesome';

library.add(faPaperPlane);
Vue.component('font-awesome-icon', FontAwesomeIcon);

@Component({})
export default class Chat extends Vue {
  @Inject() readonly api!: GameRequestAPI;

  private pendingMessage: string = '';

  private count: number = 0;

  get layout() {
    return this.$tstore.state.eventView;
  }

  get messages() {
    return this.$tstore.state.messages;
  }

  private updated() {
    if (this.layout !== 'DISABLE_CHAT') {
      const elem = this.$el.querySelector('.messages-view');
      elem!.scrollTop = elem!.scrollHeight;
    }
  }

  private toDate(unixTimestamp: number) {
    return new Date(unixTimestamp).toLocaleTimeString();
  }

  private submitToChat() {
    if (this.pendingMessage !== '') {
      this.api.sendChatMessage(this.pendingMessage);
      this.pendingMessage = '';
    }
  }
}
</script>

<style lang="scss" scoped>
@import '@/stylesheets/gamedashboard/right/Chat.scss';
</style>
